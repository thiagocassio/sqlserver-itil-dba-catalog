# üßµ 1.1.3 Exaust√£o de threads (THREADPOOL)
**Categoria:** Infraestrutura  
**CI afetado:** Inst√¢ncia SQL  
**Escopo:** Engine / Scheduler  
**Severidade sugerida:** P1  

---

## üéØ Objetivo

Identificar exaust√£o de threads (THREADPOOL) causada por excesso de sess√µes concorrentes ou consultas longas bloqueando workers dispon√≠veis.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:
```SQL
 EXEC sp_whoisactive;
```
```sql
SELECT *
FROM sys.dm_exec_requests;
```
```sql
SELECT * FROM sys.dm_os_waiting_tasks
WHERE wait_type = 'THREADPOOL';
```
---

üß† **An√°lise por DMV**
- **Waits THREADPOOL**
```sql
SELECT * FROM sys.dm_os_waiting_tasks
WHERE wait_type = 'THREADPOOL';
```

Objetivo:
- Identificar sess√µes aguardando worker threads

##

- **Sess√µes em execu√ß√£o**
```sql
SELECT *
FROM sys.dm_exec_requests;
```
Objetivo:
- Detectar consultas longas consumindo workers

##

- **An√°lise de Wait Stats**
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
```
Objetivo:
- Confirmar predomin√¢ncia de THREADPOOL

---

üñ•Ô∏è **PerfMon (Sistema Operacional)**

Principais contadores:
- SQLServer:General Statistics\User Connections
- System\Processor Queue Length
- Process(sqlservr)\Thread Count

<br>

Objetivo:
- Avaliar satura√ß√£o de workers e concorr√™ncia

---

üß∞ ScriptDBA / Ferramentas Opcionais

Ferramenta n√£o nativa:
- sp_whoisactive

Uso recomendado para identificar sess√µes bloqueadoras e long running.

---

üß© **Poss√≠veis Causas**

- Explos√£o de conex√µes simult√¢neas
- Consultas longas sem paralelismo controlado
- Bloqueios prolongados
- Configura√ß√£o inadequada de MAXDOP
- Falta de controle de pool de conex√µes na aplica√ß√£o

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Identificar sess√µes dominantes
- Avaliar bloqueios ativos
- Reduzir concorr√™ncia excessiva
- Ajustar MAXDOP (quando aplic√°vel)
- Validar configura√ß√£o de worker threads

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT *
FROM sys.dm_os_waiting_tasks
WHERE wait_type = 'THREADPOOL';
```
```sql
SELECT *
FROM sys.dm_exec_requests;
```
