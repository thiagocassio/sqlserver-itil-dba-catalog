# üß† 1.1.2 Mem√≥ria sob press√£o
**Categoria:** Infraestrutura  
**CI afetado:** Servidor SQL / Inst√¢ncia SQL  
**Escopo:** Engine / Sistema Operacional  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar press√£o de mem√≥ria no SQL Server e no Sistema Operacional, analisando grants, consumo interno e disponibilidade geral.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:
```SQL
EXEC sp_whoisactive;
```
```SQL
SELECT *
FROM sys.dm_exec_query_memory_grants;
```
```SQL
SELECT *
FROM sys.dm_os_process_memory;
```
---

üß† **An√°lise por DMV**
- **Grants de Mem√≥ria Ativos**
```SQL
SELECT *
FROM sys.dm_exec_query_memory_grants;
```

Objetivo:

- Identificar consultas aguardando mem√≥ria
- Detectar RESOURCE_SEMAPHORE

##

- **Consumo Interno de Mem√≥ria (Clerks)**
```SQL
SELECT * FROM sys.dm_os_memory_clerks
ORDER BY pages_kb DESC;
```
Objetivo:

- Identificar componentes internos com maior consumo

##

- **Mem√≥ria do Processo SQL Server**
```SQL
SELECT *
FROM sys.dm_os_process_memory;
```
Objetivo:

- Validar press√£o interna da inst√¢ncia

##

- **Mem√≥ria Dispon√≠vel no Sistema Operacional**
```SQL
SELECT *
FROM sys.dm_os_sys_memory;
```
Objetivo:

- Avaliar mem√≥ria livre no SO
- Identificar press√£o externa ao SQL Server

---

üñ•Ô∏è **PerfMon (Sistema Operacional)**

Principais contadores:

- SQLServer:Memory Manager\Memory Grants Pending
- SQLServer:Buffer Manager\Page Life Expectancy
- Memory\Available MBytes

<br>

Objetivo:

- Confirmar press√£o real de mem√≥ria
- Diferenciar gargalo SQL vs Sistema Operacional

---

üß∞ **ScriptDBA / Ferramentas Opcionais**

Ferramenta n√£o nativa:

- sp_whoisactive

Uso recomendado para an√°lise r√°pida de grants e sess√µes.

---

üß© **Poss√≠veis Causas**

- Consultas com alto consumo de mem√≥ria
- Falta de √≠ndices adequados
- Paralelismo excessivo
- Configura√ß√£o inadequada de Max Server Memory
- Press√£o externa no servidor

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Identificar sess√µes com grants elevados
- Avaliar planos de execu√ß√£o
- Ajustar Max Server Memory (quando necess√°rio)
- Revisar √≠ndices e estat√≠sticas
- Reduzir paralelismo em consultas cr√≠ticas

---

üîÅ **Monitoramento P√≥s-Mitigation**
```SQL
SELECT *
FROM sys.dm_exec_query_memory_grants;
```
```SQL
SELECT *
FROM sys.dm_os_process_memory;
```
