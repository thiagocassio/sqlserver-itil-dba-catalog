# üî• 1.1.1 CPU elevada
**Categoria:** Infraestrutura  
**CI afetado:** Servidor SQL / VM SQL / Host f√≠sico  
**Escopo:** Inst√¢ncia SQL / Engine  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo
Identificar sess√µes, consultas e waits respons√°veis por alto consumo de CPU na inst√¢ncia SQL Server.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:
EXEC sp_whoisactive;

```sql
SELECT * FROM sys.dm_exec_requests;
```

```sql
SELECT TOP 5 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
```
<br>
<br> 
üß† An√°lise por DMV
- Sess√µes ativas

```sql
SELECT * FROM sys.dm_exec_requests;
```
<br>
<br> 
- Consultas com maior consumo de CPU
```sql
SELECT TOP 10
    qs.total_worker_time,
    st.text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY qs.total_worker_time DESC;
```
<br>
<br>
- An√°lise de Waits
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
```
<br>
<br>
üìä Query Store
```sql
SELECT TOP 10 *
FROM sys.query_store_runtime_stats
ORDER BY avg_cpu_time DESC;
```
<br>
<br>
üñ•Ô∏è PerfMon (Sistema Operacional)
- Principais contadores:
- Processor(_Total)% Processor Time
- SQLServer:SQL Statistics\Batch Requests/sec
- System\Processor Queue Length

üß∞ ScriptDBA / Ferramentas Opcionais
Ferramenta n√£o nativa:
sp_whoisactive
<br>
<br>
üß© Poss√≠veis Causas
- Consulta mal otimizada
- Paralelismo excessivo
- Estat√≠sticas desatualizadas
- Plano de execu√ß√£o inadequado
- Carga externa na VM ou Host
<br>
<br>
üõ†Ô∏è A√ß√µes de Mitiga√ß√£o
- Identificar sess√£o dominante
- Avaliar plano de execu√ß√£o
- Validar √≠ndices e estat√≠sticas
- Ajustar MAXDOP (quando aplic√°vel)
- Aplicar Query Store forcing plan (se necess√°rio)
<br>
<br>
üîÅ Monitoramento P√≥s-Mitigation
```sql
SELECT * FROM sys.dm_exec_requests;
```
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
```
