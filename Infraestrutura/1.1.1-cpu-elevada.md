Infraestrutura/1.1.1-cpu-elevada.md

# üî• 1.1.1 CPU elevada
**Categoria:** Infraestrutura  
**CI afetado:** Servidor SQL / VM SQL / Host f√≠sico  
**Escopo:** Inst√¢ncia SQL / Engine  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar sess√µes, consultas e waits respons√°veis por alto consumo de CPU na inst√¢ncia SQL Server.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:


EXEC sp_whoisactive;


```sql
SELECT * FROM sys.dm_exec_requests;

SELECT TOP 5 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;

üß† An√°lise por DMV
Sess√µes ativas
SELECT * FROM sys.dm_exec_requests;

Consultas com maior consumo de CPU
SELECT TOP 10
    qs.total_worker_time,
    st.text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY qs.total_worker_time DESC;

An√°lise de Waits
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;

üìä Query Store

Verificar consultas com maior consumo hist√≥rico de CPU:

SELECT TOP 10 *
FROM sys.query_store_runtime_stats
ORDER BY avg_cpu_time DESC;

üñ•Ô∏è PerfMon (Sistema Operacional)

Principais contadores:
Processor(_Total)% Processor Time
SQLServer:SQL Statistics\Batch Requests/sec
System\Processor Queue Length

Objetivo
Validar satura√ß√£o real de CPU
Diferenciar gargalo SQL Server vs Sistema Operacional

üß∞ ScriptDBA / Ferramentas Opcionais

Ferramenta n√£o nativa:
sp_whoisactive

Uso recomendado para vis√£o consolidada de sess√µes e waits.

üß© Poss√≠veis Causas
Consulta mal otimizada
Paralelismo excessivo
Estat√≠sticas desatualizadas
Plano de execu√ß√£o inadequado
Carga externa na VM ou Host

üõ†Ô∏è A√ß√µes de Mitiga√ß√£o

Identificar sess√£o dominante
Avaliar plano de execu√ß√£o
Validar √≠ndices e estat√≠sticas
Ajustar MAXDOP (quando aplic√°vel)
Aplicar Query Store forcing plan (se necess√°rio)

üîÅ Monitoramento P√≥s-Mitigation
SELECT * FROM sys.dm_exec_requests;

SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
