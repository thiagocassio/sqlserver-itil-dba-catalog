# ğŸ”¥ 1.1.1 CPU elevada
**Categoria:** Infraestrutura  
**CI afetado:** Servidor SQL / VM SQL / Host fÃ­sico  
**Escopo:** InstÃ¢ncia SQL / Engine  
**Severidade sugerida:** P1 / P2  

---

## ğŸ¯ Objetivo
Identificar sessÃµes, consultas e waits responsÃ¡veis por alto consumo de CPU na instÃ¢ncia SQL Server.

---

## ğŸ” DiagnÃ³stico Inicial (Quick Triage)

Ferramenta opcional:

```sql
EXEC sp_whoisactive;

SELECT * FROM sys.dm_exec_requests;

SELECT TOP 5 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;

ğŸ§  AnÃ¡lise por DMV
- SessÃµes ativas
SELECT * FROM sys.dm_exec_requests;

- Consultas com maior consumo de CPU
SELECT TOP 10
    qs.total_worker_time,
    st.text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY qs.total_worker_time DESC;

- AnÃ¡lise de Waits
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;

ğŸ“Š Query Store
SELECT TOP 10 *
FROM sys.query_store_runtime_stats
ORDER BY avg_cpu_time DESC;

ğŸ–¥ï¸ PerfMon (Sistema Operacional)
- Principais contadores:
-- Processor(_Total)% Processor Time
-- SQLServer:SQL Statistics\Batch Requests/sec
-- System\Processor Queue Length

ğŸ§° ScriptDBA / Ferramentas Opcionais
Ferramenta nÃ£o nativa:
sp_whoisactive

ğŸ§© PossÃ­veis Causas
- Consulta mal otimizada
- Paralelismo excessivo
- EstatÃ­sticas desatualizadas
- Plano de execuÃ§Ã£o inadequado
- Carga externa na VM ou Host

ğŸ› ï¸ AÃ§Ãµes de MitigaÃ§Ã£o
- Identificar sessÃ£o dominante
- Avaliar plano de execuÃ§Ã£o
- Validar Ã­ndices e estatÃ­sticas
- Ajustar MAXDOP (quando aplicÃ¡vel)
- Aplicar Query Store forcing plan (se necessÃ¡rio)

ğŸ” Monitoramento PÃ³s-Mitigation
SELECT * FROM sys.dm_exec_requests;

SELECT TOP 10 *
FROM sys.dm_os_wait_stats
ORDER BY wait_time_ms DESC;
