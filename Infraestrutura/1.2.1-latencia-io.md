# üíΩ 1.2.1 Lat√™ncia de I/O elevada
**Categoria:** Infraestrutura  
**CI afetado:** Disco Data / Disco Log / Storage Azure  
**Escopo:** Arquivos MDF / NDF / LDF  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar gargalos de leitura e escrita em disco que possam impactar performance da inst√¢ncia SQL Server, avaliando lat√™ncia por arquivo e waits relacionados a I/O.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:

- EXEC sp_whoisactive;
- ```sql
SELECT *
FROM sys.dm_exec_requests;
```
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'PAGEIOLATCH%'
ORDER BY wait_time_ms DESC;
```

---

üß† **An√°lise por DMV**
- **Lat√™ncia por Arquivo**
```sql
SELECT 
    DB_NAME(vfs.database_id) AS DatabaseName,
    mf.name AS LogicalName,
    vfs.num_of_reads,
    vfs.num_of_writes,
    vfs.io_stall_read_ms,
    vfs.io_stall_write_ms
FROM sys.dm_io_virtual_file_stats(NULL, NULL) vfs
JOIN sys.master_files mf
ON vfs.database_id = mf.database_id
AND vfs.file_id = mf.file_id;
```
Objetivo:
- Identificar arquivos com maior tempo de espera em I/O

##

- **Waits Relacionados a Disco**
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'PAGEIOLATCH%'
ORDER BY wait_time_ms DESC;
```
Objetivo:
- Confirmar impacto de leitura f√≠sica em disco

##

- **Sess√µes Aguardando I/O**
```sql
SELECT *
FROM sys.dm_exec_requests
WHERE wait_type LIKE 'PAGEIOLATCH%';
```
Objetivo:
- Identificar consultas afetadas diretamente por lat√™ncia

---

üñ•Ô∏è **PerfMon (Sistema Operacional)**

Principais contadores:
- PhysicalDisk\Avg. Disk sec/Read
- PhysicalDisk\Avg. Disk sec/Write
- PhysicalDisk\Disk Transfers/sec
<br>
Objetivo:
- Validar lat√™ncia real no storage
- Diferenciar gargalo SQL vs infraestrutura

---

üß∞ **ScriptDBA / Ferramentas Opcionais**

Ferramenta n√£o nativa:
- sp_whoisactive

Uso recomendado para identificar sess√µes aguardando I/O.

--- 

üß© **Poss√≠veis Causas**

- Storage saturado
- Falta de IOPS provisionadas
- Autogrowth frequente
- √çndices fragmentados
- Consultas realizando scans extensos

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Identificar arquivo com maior lat√™ncia
- Revisar configura√ß√£o de storage
- Avaliar √≠ndices e planos de execu√ß√£o
- Ajustar tamanho inicial dos arquivos
- Validar separa√ß√£o de Data e Log

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT *
FROM sys.dm_io_virtual_file_stats(NULL, NULL);
```
```sql
SELECT *
FROM sys.dm_exec_requests
WHERE wait_type LIKE 'PAGEIOLATCH%';
```
