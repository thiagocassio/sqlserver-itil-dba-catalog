# üìä 1.2.3 Consumo anormal de storage
**Categoria:** Infraestrutura  
**CI afetado:** Storage Account / Datafiles  
**Escopo:** Tabelas / √çndices / Arquivos MDF e NDF  
**Severidade sugerida:** P2  

---

## üéØ Objetivo

Identificar crescimento inesperado de storage causado por objetos espec√≠ficos dentro do banco de dados, analisando tabelas e √≠ndices com maior ocupa√ß√£o.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

Ferramenta opcional:

EXEC sp_whoisactive;
```sql
SELECT *
FROM sys.master_files;
```

---

üß† **An√°lise por DMV**
- **Tabelas com maior consumo de espa√ßo**
```sql
SELECT TOP 10
    OBJECT_NAME(object_id) AS TableName,
    SUM(reserved_page_count) * 8 / 1024 AS SizeMB
FROM sys.dm_db_partition_stats
GROUP BY object_id
ORDER BY SizeMB DESC;
```

Objetivo:

- Identificar objetos respons√°veis pelo crescimento do banco

##

- **Arquivos do Banco**
```sql
SELECT 
    name,
    size * 8 / 1024 AS SizeMB
FROM sys.master_files;
```
Objetivo:

- Avaliar crescimento geral dos datafiles

---

üñ•Ô∏è **PerfMon (Sistema Operacional)**

Principais contadores:

- LogicalDisk\Disk Bytes/sec
- LogicalDisk% Free Space
<br>
Objetivo:

- Confirmar impacto do crescimento no storage

---

üß∞ **ScriptDBA / Ferramentas Opcionais**

Ferramenta n√£o nativa:

- sp_whoisactive

Uso recomendado para identificar sess√µes gerando grande volume de escrita.

---

üß© **Poss√≠veis Causas**

- Carga massiva de dados (ETL)
- √çndices duplicados ou n√£o utilizados
- Crescimento de tabelas hist√≥ricas
- Falta de pol√≠tica de reten√ß√£o
- Fragmenta√ß√£o elevada

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Identificar tabelas dominantes
- Avaliar compress√£o de dados
- Revisar estrat√©gia de arquivamento
- Remover √≠ndices desnecess√°rios
- Validar crescimento esperado vs real

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT TOP 10
    OBJECT_NAME(object_id) AS TableName,
    SUM(reserved_page_count) * 8 / 1024 AS SizeMB
FROM sys.dm_db_partition_stats
GROUP BY object_id
ORDER BY SizeMB DESC;
```
```sql
SELECT 
    name,
    size * 8 / 1024 AS SizeMB
FROM sys.master_files;
```
