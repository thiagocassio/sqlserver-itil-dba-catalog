# üì¶ 2.2.3 Falha de Log Shipping
**Categoria:** Plataforma SQL Server  
**CI afetado:** Configura√ß√£o de Log Shipping  
**Escopo:** Backup / Copy / Restore de Transaction Log  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar falhas no processo de Log Shipping envolvendo etapas de backup, c√≥pia ou restore dos transaction logs entre servidor prim√°rio e secund√°rio.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

```sql
SELECT *
FROM msdb.dbo.log_shipping_monitor_primary;
```
```sql
SELECT *
FROM msdb.dbo.log_shipping_monitor_secondary;
```
---

üß† **An√°lise por Monitoramento**
- **Status do Servidor Prim√°rio**
```sql
SELECT 
    primary_database,
    last_backup_date,
    backup_threshold,
    backup_out_of_date
FROM msdb.dbo.log_shipping_monitor_primary;
```
Objetivo:

- Verificar se backup est√° atrasado

##

- **Status do Servidor Secund√°rio**
```sql
SELECT 
    secondary_database,
    last_copy_date,
    last_restore_date,
    restore_threshold,
    restore_out_of_date
FROM msdb.dbo.log_shipping_monitor_secondary;
```
Objetivo:

- Identificar atraso na c√≥pia ou restore

##

- **Jobs Relacionados**
```sql
SELECT 
    name,
    enabled
FROM msdb.dbo.sysjobs
WHERE name LIKE '%Log Shipping%';
```
Objetivo:

- Confirmar se jobs de backup/copy/restore est√£o habilitados

--- 

üñ•Ô∏è **Verifica√ß√£o no Sistema de Arquivos**

- Confirmar exist√™ncia dos arquivos .trn
- Validar permiss√£o de acesso ao compartilhamento
- Verificar espa√ßo dispon√≠vel no destino

---

üß© **Poss√≠veis Causas**

- Job de backup falhou
- Falha na c√≥pia de arquivos
- Problema de permiss√£o no compartilhamento
- Restore job parado
- Espa√ßo insuficiente no servidor secund√°rio

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Executar manualmente o job de backup
- Validar acesso ao compartilhamento
- Executar job de copy/restore manualmente
- Ajustar thresholds de monitoramento
- Verificar hist√≥rico do SQL Server Agent

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT 
    primary_database,
    last_backup_date
FROM msdb.dbo.log_shipping_monitor_primary;
```
```sql
SELECT 
    secondary_database,
    last_restore_date
FROM msdb.dbo.log_shipping_monitor_secondary;
```
