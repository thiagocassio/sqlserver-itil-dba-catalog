# üîÅ 2.2.1 Falha de Always On Availability Groups
**Categoria:** Plataforma SQL Server  
**CI afetado:** Availability Group / R√©plica  
**Escopo:** Alta Disponibilidade / Sincroniza√ß√£o  
**Severidade sugerida:** P1  

---

## üéØ Objetivo

Identificar falhas de sincroniza√ß√£o, indisponibilidade ou problemas de comunica√ß√£o entre r√©plicas em ambientes Always On Availability Groups.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

```sql
SELECT *
FROM sys.dm_hadr_availability_replica_states;
```
```sql
SELECT *
FROM sys.dm_hadr_database_replica_states;
```
---

üß† **An√°lise por DMV**
- **Estado das R√©plicas**
```sql
SELECT 
    replica_server_name,
    synchronization_state_desc,
    connected_state_desc,
    role_desc
FROM sys.dm_hadr_availability_replica_states ars
JOIN sys.availability_replicas ar
ON ars.replica_id = ar.replica_id;
```
Objetivo:

- Validar se r√©plica est√° sincronizada
- Confirmar papel (PRIMARY / SECONDARY)

##

- ** Estado dos Bancos na AG**
```sql
SELECT 
    database_id,
    synchronization_state_desc,
    is_suspended,
    log_send_queue_size,
    redo_queue_size
FROM sys.dm_hadr_database_replica_states;
```
Objetivo:

- Identificar atraso de log
- Verificar bancos suspensos

##

- **Cluster e Quorum**
```sql
SELECT *
FROM sys.dm_hadr_cluster;
```
Objetivo:
- Validar comunica√ß√£o com WSFC

--- 

üñ•Ô∏è **Verifica√ß√£o no Sistema Operacional**

PowerShell:
```PowerShell
Get-ClusterNode
```
```PowerShell
Get-ClusterGroup
```
<br>
Objetivo:

- Confirmar estado do cluster
- Identificar recursos offline

---

üß© **Poss√≠veis Causas**

- Perda de comunica√ß√£o entre n√≥s
- Falha de rede
- Storage indispon√≠vel
- Log send queue elevado
- Banco suspenso manualmente
- Problema no endpoint HADR

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Verificar conectividade entre r√©plicas
- Avaliar log_send_queue_size e redo_queue_size
- Reiniciar endpoint HADR (se necess√°rio)

Retomar banco suspenso:
```sql
ALTER DATABASE [NomeDoBanco] SET HADR RESUME;
```
- Validar estado do cluster

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT 
    replica_server_name,
    synchronization_state_desc,
    connected_state_desc
FROM sys.dm_hadr_availability_replica_states ars
JOIN sys.availability_replicas ar
ON ars.replica_id = ar.replica_id;
```
