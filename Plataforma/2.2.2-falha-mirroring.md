# üîÑ 2.2.2 Falha de Mirroring
**Categoria:** Plataforma SQL Server  
**CI afetado:** Database Mirroring / Endpoint  
**Escopo:** Alta Disponibilidade / Comunica√ß√£o entre n√≥s  
**Severidade sugerida:** P1  

---

## üéØ Objetivo

Identificar falhas de comunica√ß√£o, desconex√£o ou estado inconsistente em ambientes configurados com Database Mirroring.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

```sql
SELECT *
FROM sys.database_mirroring
WHERE mirroring_guid IS NOT NULL;
```
```sql
SELECT *
FROM sys.endpoints
WHERE type_desc = 'DATABASE_MIRRORING';
```

---

üß† **An√°lise por DMV**
- **Estado do Mirroring**
```sql
SELECT 
    database_id,
    mirroring_state_desc,
    mirroring_role_desc,
    mirroring_partner_name,
    mirroring_safety_level_desc
FROM sys.database_mirroring
WHERE mirroring_guid IS NOT NULL;
```
Objetivo:

- Verificar papel (PRINCIPAL / MIRROR)
- Confirmar estado da sess√£o

##

- **Status do Endpoint**
```sql 
SELECT 
    name,
    state_desc,
    type_desc
FROM sys.endpoints
WHERE type_desc = 'DATABASE_MIRRORING';
```
Objetivo:

- Confirmar se endpoint est√° STARTED

--- 

üñ•Ô∏è **Verifica√ß√£o de Conectividade**

- Testar porta configurada (exemplo 5022):
```Telnet
telnet servidor_remoto 5022
```
<br>
Objetivo:

- Validar comunica√ß√£o entre os parceiros

---

üß© **Poss√≠veis Causas**

- Endpoint parado
- Porta bloqueada no firewall
- Certificado expirado (quando aplic√°vel)
- Banco em estado SUSPENDED
- Falha de rede entre servidores

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Iniciar endpoint:
```sql
ALTER ENDPOINT [NomeEndpoint] STATE = STARTED;
```
- Retomar sess√£o suspensa:
```sql
ALTER DATABASE [NomeDoBanco] SET PARTNER RESUME;
```

- Validar conectividade de rede
- Revisar certificados (quando utilizados)

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT 
    database_id,
    mirroring_state_desc,
    mirroring_role_desc
FROM sys.database_mirroring
WHERE mirroring_guid IS NOT NULL;
```
