# üß† 2.1.1 Conten√ß√£o de TempDB
**Categoria:** Plataforma SQL Server  
**CI afetado:** TempDB  
**Escopo:** Engine / Concorr√™ncia Interna  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar conten√ß√£o de recursos internos na TempDB causada por alta concorr√™ncia, aloca√ß√£o excessiva ou configura√ß√£o inadequada de arquivos.

---

## üîé Diagn√≥stico Inicial (Quick Triage)

```sql
SELECT *
FROM sys.dm_exec_requests
WHERE database_id = 2;
```
```sql
SELECT *
FROM sys.dm_os_waiting_tasks
WHERE wait_type LIKE 'PAGELATCH%';
```

---

üß† **An√°lise por DMV**
- **Waits Relacionados √† TempDB**
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'PAGELATCH%'
ORDER BY wait_time_ms DESC;
```
Objetivo:

- Identificar conten√ß√£o de p√°ginas internas (PFS, GAM, SGAM)

##

- **Arquivos da TempDB**
```sql
SELECT 
    name,
    size * 8 / 1024 AS SizeMB,
    physical_name
FROM tempdb.sys.database_files;
```
Objetivo:

- Validar quantidade e tamanho dos arquivos

##

- **Sess√µes Utilizando TempDB**
```sql
SELECT 
    session_id,
    user_objects_alloc_page_count,
    internal_objects_alloc_page_count
FROM sys.dm_db_session_space_usage
ORDER BY internal_objects_alloc_page_count DESC;
```
Objetivo:

- Identificar sess√µes consumindo TempDB excessivamente

---

üñ•Ô∏è **PerfMon**

Principais contadores:

- SQLServer:Transactions\Free Space in tempdb (KB)
- SQLServer:Databases\Log File(s) Used Size (KB)
<br>
Objetivo:

- Validar press√£o real na TempDB

---

üß© **Poss√≠veis Causas**

- Alta concorr√™ncia em tabelas tempor√°rias
- Uso intenso de sort/hash operations
- Poucos arquivos na TempDB
- Autogrowth frequente
- √çndices inadequados gerando spill para TempDB

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Aumentar n√∫mero de datafiles da TempDB (regra geral: 1 por core l√≥gico at√© 8)
- Garantir tamanhos iguais entre arquivos
- Ajustar tamanho inicial adequado
- Revisar consultas com spill para TempDB
- Monitorar opera√ß√µes de hash/sort

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'PAGELATCH%';
```
```sql SELECT * FROM sys.dm_db_session_space_usage;
```
