# üîí 2.1.2 Conten√ß√£o de locks / latches
**Categoria:** Plataforma SQL Server  
**CI afetado:** Inst√¢ncia SQL / Database espec√≠fico  
**Escopo:** Engine / Concorr√™ncia  
**Severidade sugerida:** P1 / P2  

---

## üéØ Objetivo

Identificar conten√ß√£o causada por bloqueios (locks) e latches internos que impactam concorr√™ncia, throughput e tempo de resposta da inst√¢ncia SQL Server.

---

## üîé **Diagn√≥stico Inicial (Quick Triage)**

```sql
SELECT *
FROM sys.dm_exec_requests
WHERE blocking_session_id <> 0;
```
```sql
SELECT *
FROM sys.dm_os_waiting_tasks
WHERE wait_type LIKE 'LCK%';
```
---

üß† **An√°lise por Locks**
- **Sess√µes Bloqueadas**
```sql
SELECT 
    session_id,
    blocking_session_id,
    wait_type,
    wait_time,
    wait_resource
FROM sys.dm_exec_requests
WHERE blocking_session_id <> 0;
```
Objetivo:
- Identificar cadeia de bloqueio (blocking chain)

##

- **Locks Ativos**
```sql
SELECT *
FROM sys.dm_tran_locks;
```
Objetivo:

- Verificar tipo de lock (X, S, IX, etc.)
- Identificar objetos impactados

##

üß† - **An√°lise por Latches**
- **Waits de Latch**
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'LATCH%'
ORDER BY wait_time_ms DESC;
```
Objetivo:

- Detectar conten√ß√£o interna de estruturas de mem√≥ria

---

üñ•Ô∏è **PerfMon**

Principais contadores:

- SQLServer:Locks\Lock Waits/sec
- SQLServer:Locks\Average Wait Time (ms)
- SQLServer:SQL Statistics\Batch Requests/sec
<br>
Objetivo:

- Avaliar impacto real na concorr√™ncia

---

üß∞ **ScriptDBA / Ferramentas Opcionais**

Ferramenta n√£o nativa:
```sql
sp_whoisactive
```
Uso recomendado para visualizar bloqueios e cadeia de sess√µes.

---

üß© **Poss√≠veis Causas**

- Transa√ß√µes longas
- Falta de √≠ndices adequados
- N√≠vel de isolamento elevado
- Opera√ß√µes de UPDATE/DELETE massivas
- Escalonamento de lock (Lock Escalation)

---

üõ†Ô∏è **A√ß√µes de Mitiga√ß√£o**

- Identificar sess√£o raiz do bloqueio
- Avaliar plano de execu√ß√£o
- Criar ou ajustar √≠ndices
- Revisar n√≠vel de isolamento
- Considerar uso de READ_COMMITTED_SNAPSHOT (quando aplic√°vel)

---

üîÅ **Monitoramento P√≥s-Mitigation**
```sql
SELECT *
FROM sys.dm_exec_requests
WHERE blocking_session_id <> 0;
```
```sql
SELECT TOP 10 *
FROM sys.dm_os_wait_stats
WHERE wait_type LIKE 'LCK%'
ORDER BY wait_time_ms DESC;
```
